<mat-card class="history-card">
  <mat-card-header>
    <mat-card-title>История состояний</mat-card-title>
    <mat-card-subtitle>Последние 30 дней</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <!-- Кнопка пересчёта -->
    <div class="controls">
      <button
        mat-raised-button
        color="primary"
        (click)="recalculateState()"
        [disabled]="isRecalculating"
      >
        <mat-icon *ngIf="isRecalculating" class="spinner">autorenew</mat-icon>
        {{ isRecalculating ? 'Идёт расчёт...' : 'Пересчитать состояние' }}
      </button>
    </div>

    <!-- Прогресс-бар при пересчёте -->
    <mat-progress-spinner
      *ngIf="isRecalculating"
      mode="indeterminate"
      diameter="30"
      style="display: block; margin: 10px auto"
    ></mat-progress-spinner>

    <!-- Таблица -->
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z2">
      <!-- Дата -->
      <ng-container matColumnDef="created_at">
        <th mat-header-cell *matHeaderCellDef>Дата</th>
        <td mat-cell *matCellDef="let row">
          {{ row.created_at | date : 'dd.MM.yyyy HH:mm' }}
        </td>
      </ng-container>

      <!-- Статус -->
      <ng-container matColumnDef="state">
        <th mat-header-cell *matHeaderCellDef>Статус</th>
        <td mat-cell *matCellDef="let row">
          <span class="badge" [class]="getStatusClass(row.state)">
            {{ getStatusText(row.state) }}
          </span>
        </td>
      </ng-container>

      <!-- Комментарий -->
      <ng-container matColumnDef="comment">
        <th mat-header-cell *matHeaderCellDef>Комментарий</th>
        <td mat-cell *matCellDef="let row">
          <!-- Только для старшего специалиста — клик открывает диалог -->
          <span
            *ngIf="role === 'senior-specialist'"
            (click)="startEditing(row)"
            class="editable-comment"
            style="cursor: pointer; border-bottom: 1px dashed #0066cc"
          >
            {{ row.comment || '(нет)' }}
          </span>
          <!-- Для обычного специалиста — только просмотр -->
          <span *ngIf="role !== 'senior-specialist'">
            {{ row.comment || '-' }}
          </span>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </mat-card-content>
</mat-card>
